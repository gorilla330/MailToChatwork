## このスクリプトでできること

- Gmailの問い合わせメールを、Chatworkの指定ルームに「メッセージ通知」として自動投稿します。
- 処理ログと集計（カテゴリ別の件数）をGoogleスプレッドシートに自動で記録します。
- 同じスレッド内でも、新しいメール（メッセージ）ごとに個別に通知します（重複判定はメッセージIDで行います）。

### 想定ユーザー
- Googleアカウントがあり、Gmail/スプレッドシート/Apps Script を使ったことがない、または慣れていない方でも設定できるように書いています。

---

## 事前に用意するもの

- Chatwork
  - ルームID（タスクを作成したいルーム）
  - APIトークン（`X-ChatWorkToken`）
  - 担当者の `account_id`（任意。未指定でもOK）
- Google
  - Gmail（問い合わせメールが届くアドレス）
  - Google スプレッドシート（ログ・集計の保存先）

---

## 導入の全体像（流れ）

1) Chatwork側の準備 → 2) スプレッドシート作成 → 3) Apps Script を配置 → 4) `CONFIG` を設定（テスト/本番の切替も）→ 5) スクリプトプロパティにトークン格納 → 6) 手動実行で動作確認 → 7) 時間トリガーを設定

---

## 1. Chatwork 側の準備

### 1-1. ルームIDの確認
- ブラウザで目的のChatworkルームを開き、URLの `.../#!ridXXXXXXXX` の数字部分がルームIDです。

### 1-2. APIトークンの取得
- Chatworkの「個人設定」→「API設定」から発行できます。
- 発行されたトークン文字列を控えておきます（後でApps Scriptに設定します）。

### 1-3. 担当者 `account_id` の確認（任意）
- 後述のApps Script内の関数 `cwListMembers()` を一度実行すると、対象ルームのメンバー一覧がログ出力されます。その中の `account_id` を `TO_IDS_CSV` にカンマ区切りで設定します。
- 例: `"11111,22222"`
- 全員未指定にしたい場合は空文字にしてOKです。

---

## 2. スプレッドシートの準備

1) Googleドライブで新しいスプレッドシートを作成します。
2) ブラウザのURLに含まれるIDが「スプレッドシートID」です（`/d/` と `/edit` の間の長い文字列）。
3) このIDを後で `CONFIG.SPREADSHEET_ID` に設定します。

補足:
- シート名 `log` と `summary` はスクリプトが自動で作成します。空のスプレッドシートでOKです。

---

## 3. Apps Script（GAS）の準備

### 3-1. プロジェクトを開く
- Googleドライブで「新規」→「その他」→「Google Apps Script」を開きます。
- すでに本リポジトリからコードを持っている場合は、`MailToCW.gs` の中身をエディタに貼り付けます（既にエディタにある場合はこの手順は不要）。

### 3-2. 必要な権限
- 初回実行時に、以下のアクセス許可が求められます。
  - Gmail（メールの検索・取得）
  - スプレッドシート（ログの記録）
  - 外部通信（Chatwork API へのリクエスト）
  - スクリプトプロパティ（APIトークンの保存・読み込み）

---

## 4. スクリプト設定（CONFIG）

`MailToCW.gs` の先頭にある `CONFIG` を自分の環境に合わせて設定します。

- `INFO_ADDRESS`: 問い合わせを受け取るメールアドレス（Gmailの検索に使います）
- `SUBJECT_HOOK`: 対象メールの件名を判定する正規表現（本運用では次の2条件のみ許可）
  - 完全一致: 「お問い合わせがありました」
  - 含有一致: 「＜至急＞<B肝新規相談会申込>」を含む件名
- `SUBJECT_QUERIES`: Gmail検索で使う件名フレーズの配列（OR 検索に使用）
  - `["お問い合わせがありました", "＜至急＞<B肝新規相談会申込>"]`
- `DONE_LABEL`: 視認用のGmailラベル名（任意に変更可）
- モード/投稿先:
  - `MODE`: `'test'` または `'prod'`
  - `TEST_ROOM_ID`: テスト通知を送るルーム（例: マイチャットのID `5564141`）
  - `PROD_ROOM_ID`: 本番通知を送るルーム（例: 全体スレのID `18848369`）
- `TO_IDS_CSV`: 担当者の `account_id` をカンマ区切り（例: `"11111,22222"`）。通知投稿では未使用です
- `TOKEN_PROP_KEY`: スクリプトプロパティに保存するキー名（通常は既定のままでOK）
- `TITLE_LINE`: タスク本文の先頭に入るタイトル
- `INCLUDE_FULL_BODY`: Chatwork通知本文にメール全文を含めるか（true/false）
- `MAX_BODY_LEN`: 取り込む本文の最大文字数（セーフガード）
- `DUE`: タスクの期日（有効/日数/時刻/タイムゾーン）
- `CATEGORIES`: 件名でカテゴリを自動判定するためのリスト（未マッチは `DEFAULT_CATEGORY`）
- `SPREADSHEET_ID`: 作成したスプレッドシートのID
- `SHEET_LOG`, `SHEET_SUMMARY`: シート名（既定のままでOK）
- `SEARCH_DAYS`: Gmail検索の対象期間（日数）。時間トリガーで定期的に実行するため、最近n日分を検索します。

ポイント:
- このスクリプトは「受信イベントで自動起動」ではなく、時間トリガーで定期実行されます。そのため `SEARCH_DAYS` の範囲で新着メールを見に行く（ポーリング）方式です。
- 重複防止は「メッセージID」をログに保存して判定します。同じスレッドに新しいメールが届けば、そのメールごとにタスクが作成されます。

---

## 4-1. 対象メールの条件（重要）

- 受信アドレスで絞り込み: `deliveredto:INFO_ADDRESS`
- 期間で絞り込み: `newer_than:SEARCH_DAYS d`
- 件名（完全一致/含有一致）
  - 完全一致: `subject:"お問い合わせがありました"`
  - 含有一致: `subject:"＜至急＞<B肝新規相談会申込>"`
- 実際のGmail検索クエリ例:
  - `deliveredto:info@ascope.net newer_than:2d (subject:"お問い合わせがありました" OR subject:"＜至急＞<B肝新規相談会申込>")`

※ コード上では `SUBJECT_QUERIES` を OR 連結し、さらに `SUBJECT_HOOK` で最終フィルタ（厳格化）しています。

---

## 4-2. 通知先のルール

- 至急判定: 件名または本文に「至急」を含む場合は「至急」と見なす
- 通知先:
  - 至急: 全体スレ（`PROD_ROOM_ID`）
  - 非至急: 件名からカテゴリ自動判定 → `ROOM_MAP` の各ルームへ

---

## 4-3. カテゴリ判定（件名）

- 判定パターン（抜粋）
  - 労働: `/労働[ＬL]Ｐ|労働/`
  - アスベスト: `/アスベスト|石綿/`
  - B型肝炎: `/B型肝炎訴訟|B型肝炎給付金|B型肝炎|B肝/`
  - トップページ: `/ascope\.net・トップページ|トップページ/`
- ルーム対応（本番）
  - 一般案件: `ROOM_MAP.general`
  - 労働: `ROOM_MAP.labor`
  - B型肝炎: `ROOM_MAP.bkan`
  - アスベスト: `ROOM_MAP.asbestos`

注: 至急はカテゴリに関わらず全体スレ（`PROD_ROOM_ID`）に投稿されます。

---

## 5. スクリプトプロパティにトークンを保存

1) Apps Scriptエディタ上部の「プロジェクトの設定（歯車アイコン）」→「スクリプトプロパティを開く」。
2) 「追加」をクリックして、以下を登録します。
   - プロパティ名: `CHATWORK_TOKEN`（または `CONFIG.TOKEN_PROP_KEY` の値）
   - 値: Chatworkで発行したAPIトークン
3) 保存します。

---

## 6. 動作確認（手動実行）

1) `MailToCW.gs` の関数一覧から `createTasksWithLogging` を選び、「実行」。
2) 初回は認可ダイアログが出るので、案内に従って権限を許可します。
3) 実行が終わったら、以下を確認します。
   - Chatworkの指定ルームに通知メッセージが投稿されている
   - スプレッドシートの `log` シートに処理履歴が追加されている
   - `summary` シートにカテゴリ別の集計が出ている
   - 対象メール（メッセージ）に `DONE_LABEL` が付与されている（視認用）

必要に応じて：
- `cwListMembers()` を実行すると、ルームメンバーの `account_id` がログに出力されます（`TO_IDS_CSV` 設定の補助）。

---

## 7. 自動化（時間トリガーの設定）

1) Apps Scriptの左メニュー「トリガー」→「トリガーを追加」。
2) 次のように設定します。
   - 実行する関数: `createTasksWithLogging`
   - 実行するデプロイ: Head
   - イベントのソース: 時間主導型
   - 時間ベースのトリガーのタイプ: 分ベース or 時間ベース
   - 間隔: 運用に合わせて（例: 5分/15分/1時間など）
3) 保存すれば、指定間隔で自動実行されます。

補足:
- 頻度を上げるほどGmail検索の回数が増えます。負荷やレート制限を考慮して適切な間隔を選んでください。

---

## 8. うまく動かないとき（チェックリスト）

- Chatworkに通知が投稿されない
  - `SCRIPT PROPERTIES` に `CHATWORK_TOKEN` は入っていますか？スペルミスはありませんか？
  - `CONFIG.MODE` と `TEST_ROOM_ID` / `PROD_ROOM_ID` は正しく設定されていますか？
  - `SUBJECT_HOOK` に件名がマッチしていますか？（本運用では次のどちらかのみ）
    - 「お問い合わせがありました」（完全一致）
    - 「＜至急＞<B肝新規相談会申込>」（含有一致）
  - APIエラーが発生していないか（スクリプト実行ログにエラーメッセージが出ます）

- ログがスプレッドシートに出ない
  - `CONFIG.SPREADSHEET_ID` は正しいですか？アクセス権はありますか？

- タスクが重複して作成される
  - `log` シートの `gmail_message_id`（C列）に同じIDが2つ無いか確認。トリガーの多重起動が疑われる場合は、実行間隔を広げたり、Apps Scriptの実行履歴で重複起動がないか確認してください。

- メールが拾われない
  - `INFO_ADDRESS` が実際の受信アドレスと一致していますか？
  - 実行タイミングによっては `SEARCH_DAYS` の範囲外になることがあります。値を一時的に広げてテストしてください。

---

## 9. セキュリティの注意

- Chatwork APIトークンはスクリプトプロパティに保存し、コード内に直書きしないでください。
- スプレッドシートは社内の必要最小限の共有にとどめてください。
- Apps Scriptの権限は初回実行時に付与します。信頼できるアカウントでのみ設定してください。

---

## 10. 補足（設計のポイント）

- 重複防止は「スレッドID」ではなく「メッセージID」で行います。スレッドに新規メールが追加されるたびに、別タスクが作成されます。
- Gmailは受信イベントで自動実行できないため、時間トリガーで定期的に検索（`SEARCH_DAYS`）し、未処理分のみを処理します。
- 通知本文にはGmailのスレッドリンクを含み、長文は `MAX_BODY_LEN` で切り詰めます。

---

## 変更履歴（要点）
- v4: 件名フィルタを「完全一致: お問い合わせがありました」「含有一致: ＜至急＞<B肝新規相談会申込>」の2条件に限定。至急は一律で全体スレに通知。

- v3: Chatwork「タスク作成」から「メッセージ通知（投稿）」へ変更。テスト/本番の投稿先切替（`MODE`）を追加。
- v2: 重複判定をメッセージIDベースに変更。スレッド内の複数メールを個別通知化。`SEARCH_DAYS` を導入。
- v1: スレッドIDベースで一度のみ処理。


